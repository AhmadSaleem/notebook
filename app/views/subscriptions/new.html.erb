<% free_for_life_user = current_user.selected_billing_plan_id == 2 %>
<% on_premium_plan = ['early-adopters', 'premium'].include? @active_billing_plan.stripe_plan_id %>

<p class="right hide-on-small-only">
  <% [Character, Location, Item, Creature, Race, Religion, Group, Magic, Language, Scene].each do |content_class| %>
    <% can_create = current_user.can_create?(content_class) %>
    <% edit_message = current_user.send(content_class.name.pluralize.downcase).any? && !can_create %>
    <i class="material-icons <%= can_create ? content_class.color : 'grey' %>-text tooltipped" style="font-size: 240%" data-position="bottom" data-delay="0" data-tooltip="You <%= can_create ? 'can' : 'cannot' %> create new <%= content_class.name.pluralize.downcase %>.<%= ' You can edit your existing ones.' if edit_message %>">
      <%= content_class.icon %>
    </i>
  <% end %>
</p>

<h4>Subscription Plan</h4>

<p>
  <% if free_for_life_user %>
    <p style="margin-top: 20px;">
    Thank you! You were there at Notebook.ai's beginnings, so we've gifted you <strong>a free, unlimited account for life</strong>. Subscriptions below have been disabled, because you already have everything unlocked.
    </p>
    <p>
      Thank you for helping make Notebook.ai what it is today.
    </p>
  <% else %>
    You're currently subscribed to Notebook's <strong><%= @active_billing_plan.name %></strong> plan.
    <% unless @active_billing_plan.nil? || @active_billing_plan.stripe_plan_id == 'starter' %>
      Your subscription will be active until <%= current_user.active_subscriptions.first.end_date.strftime('%B %d, %Y') %>, when it will automatically renew for another month.
    <% end %>
  <% end %>
</p>

<div class="row">
  <div class="col s12 m6">
    <div class="row">
      <div class="card s12 <%= 'green lighten-5' if on_premium_plan %>">
        <div class="center">
          <br />
          <i class="material-icons" style="font-size: 250%">class</i>
          <h4>Premium</h4>
          <h5>$9/month</h5>
          <ul class="plan-features">
            <li>Plan <strong>unlimited</strong> universes</li>
            <li>Upload up to <strong>1GB</strong> of images</li>
            <li>Create the following content within your universes:</li>
            <li>
              <% [Character, Location, Item, Creature, Race, Religion, Group, Magic, Language, Scene].each do |content_class| %>
                <i class="material-icons <%= content_class.color %>-text tooltipped" style="font-size: 240%" data-position="bottom" data-delay="0" data-tooltip="<%= content_class.name.pluralize %>">
                  <%= content_class.icon %>
                </i>
              <% end %>
            </li>
          </ul>
        </div>
        <div class="row center">
          <% if on_premium_plan %>
            <%= link_to 'Plan is active', '#', class: 'btn-large waves-effect waves-light white black-text disabled' %>
          <% else %>
            <%= link_to 'Upgrade', change_subscription_path('premium'), class: "btn-large waves-effect waves-light blue white-text #{'disabled' if free_for_life_user}" %>
          <% end %>
        </div>
        <br />
      </div>
    </div>
    <div class="row">
      <% if on_premium_plan || free_for_life_user %>
        <div class="card" style="padding: 15px; font-size: 110%">
          <h5>Want to support Notebook.ai even further?</h5>
          <p>
            Every little bit helps! <a href="https://www.patreon.com/indentlabs">Visit us on Patreon</a> to pledge as little or as much as you'd
            like each month, with proceeds going directly towards Notebook.ai hosting and upkeep costs. Thank you for your support!
          </p>
        </div>
      <% end %>
    </div>
  </div>
  <div class="col s12 m6">
    <div class="row">
      <div class="card s12 <%= 'green lighten-5' if @active_billing_plan.stripe_plan_id == 'starter' %>">
        <div class="center">
          <br />
          <i class="material-icons" style="font-size: 250%">class</i>
          <h4>Starter</h4>
          <h5>$0/month</h5>
          <ul class="plan-features">
            <li>Plan up to <strong>5</strong> universes</li>
            <li>Upload up to <strong>50MB</strong> of images</li>
            <li>Create the following content within your universes:</li>
            <li>
              <% [Character, Location, Item].each do |content_class| %>
                <i class="material-icons <%= content_class.color %>-text tooltipped" style="font-size: 240%" data-position="bottom" data-delay="0" data-tooltip="<%= content_class.name.pluralize %>">
                  <%= content_class.icon %>
                </i>
              <% end %>
            </li>
          </ul>
        </div>
        <div class="row center">
          <% if @active_billing_plan.stripe_plan_id == 'starter' %>
            <%= link_to 'Plan is active', '#', class: 'btn-large waves-effect waves-light white disabled black-text' %>
          <% else %>
            <%= link_to 'Downgrade', change_subscription_path('starter'), class: "btn-large waves-effect waves-light white black-text #{'disabled' if free_for_life_user}" %>
          <% end %>
        </div>
        <br />
      </div>
    </div>
  </div>
</div>

<h4>Payment method</h4>

<div class="row">
  <div class="col s12 m4">
    <div class="card" style="padding: 15px;">
      <p>
        <strong>For your security, we don't store any of your payment information or personal information on file.</strong>
      </p>
      <p>
        Instead, we rely on industry-leading payment processor Stripe to process payments and handle your
        subscription info.
      </p>
    </div>
  </div>

  <% if @stripe_customer.sources.total_count == 0 %>
    <div class="col s12 m4">
      <div class="card" style="padding: 15px">
        <p>
          We don't currently have a payment method on file for you. You'll be asked to add one whenever you
          upgrade, but you can add one at any time here.
        </p>
        <p>
          <%= link_to "Add payment method", payment_info_path, class: 'btn' %>
        </p>
      </div>
    </div>
  <% else %>
    <div class="col s12 m8">
      <div class="card" style="padding: 15px">
        <p>
          We have a payment method on file for you through Stripe
          (<%= @stripe_customer.sources.data[0].brand %> ending in <%= @stripe_customer.sources.data[0].last4 %>),
          but since we don't store it locally, you cannot edit it. You can choose to add a new one (replacing the old),
          or delete the existing one.
        </p>
        <p>
          <%= link_to "Add new payment method", payment_info_path, class: 'btn white black-text' %>
        </p>
        <p>
          <%= link_to "Delete existing payment method", delete_payment_method_path, class: 'btn white black-text' %>
        </p>
      </div>
    </div>
  <% end %>
</div>

<h4>
  Upload Bandwidth
  <small class="grey-text">
    <%= Filesize.from("#{current_user.upload_bandwidth_kb}KB").pretty %>
  </small>
</h4>
<div class="row">
  <div class="col s12">
    <div class="card" style="padding: 15px">
      <p>
        You have <strong><%= Filesize.from("#{current_user.upload_bandwidth_kb}KB").pretty %></strong> of bandwidth remaining.
      </p>
      <p>
        This bandwidth can be used to upload images to your content anywhere on the site. Deleting an uploaded image frees
        up the same amount of bandwidth.
        <% unless on_premium_plan %>
          To get more bandwidth, upgrade to our Premium plan.
        <% end %>
      </p>
    </div>
  </div>
</div>

<h4>Billing History</h4>
<table class="bordered">
  <thead>
    <tr>
      <th>Date</th>
      <th>Description</th>
      <th>Amount Billed</th>
    </tr>
  </thead>
  <tbody>
    <% @stripe_invoices.first(5).each do |invoice| %>
      <tr>
        <td>
          <%= Time.at(invoice.date).strftime('%B %d, %Y, %I:%M:%S %p') %>
          <%= '(Pending)' if Time.at(invoice.date) > Time.now %>
        </td>
        <td>
          <ul>
            <% invoice.lines.data.reverse.each do |line_item| %>
              <li>
                <%
                  action = line_item.amount < 0 ? 'prorated' : 'charged'
                  if line_item.description.nil?
                    description = [
                      "one month of #{line_item.plan.name}, ",
                      "from #{Time.at(line_item.period.start).strftime('%B %d')} ",
                      "to #{Time.at(line_item.period.end).strftime('%B %d, %Y')}"
                    ].join
                  else
                    description = line_item.description
                  end
                %>

                You were <%= action %> <%= number_to_currency(line_item.amount / 100) %> for <%= description %>.
              </li>
            <% end %>
          </ul>
        </td>
        <td>
          <%= number_to_currency(invoice.amount_due / 100) %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>
