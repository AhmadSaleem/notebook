<div class="nested-fields">

  <% uuid = SecureRandom.uuid %>

  <% if f.object && f.object.send(attribute) %>
    <% klass = f.object.send(attribute).class %>

    <div class="chip">
      <%= link_to f.object.send(attribute) do %>
        <span class="<%= klass.color %>-text">
          <i class="material-icons left"><%= klass.icon %></i>
        </span>
        <%= f.object.send(attribute).name %>
      <% end %>
    </div>

    <%= link_to_remove_association 'remove', f %>

  <% else %>
    <% klass = parent.send(attribute.pluralize).build.class.name.downcase %>

    <div class="input-field">
      <%= f.label attribute %>
      <%= f.autocomplete_field "#{attribute}_id", send("autocomplete_name_#{klass.pluralize}_path"), 'data-auto-focus' => true, id_element: "##{uuid}" %>
      <%= f.hidden_field "#{attribute}_id", id: uuid %>

      <%= link_to_remove_association 'remove', f %>
    </div>

  <% end %>
</div>